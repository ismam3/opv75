<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Model Viewer - Working Solution</title>
    
    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/black.css">
    
    <style>
        .model-container {
            width: 90%;
            height: 600px;
            margin: 20px auto;
            background: #0a0a0a;
            position: relative;
            border: 1px solid #333;
        }
        
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 10px;
            color: white;
            text-align: center;
            max-width: 80%;
            font-family: Arial, sans-serif;
        }
        
        .success { color: #4CAF50; }
        .warning { color: #ff9800; }
        .error { color: #f44336; }
        
        .button {
            display: inline-block;
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
        }
        
        .button:hover {
            background: #1976D2;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #00aaff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <h2>75m Offshore Patrol Vessel</h2>
				<p>
					<strong>Project team</strong><br>
					<ul>
                        <li>Ismam Labib</li>
                        <li>Khandaker Marufa</li>
                        <li>Adullah Al Niaz Rahman</li>
                    </ul><br>
					Batch: NAOE-06 <br>
					<br><br>
					<strong>Supervised By</strong><br>
					Prof. Dr. Md. Sadiqul Baree<br>
				</p>
            </section>
			<section>
				<h1 class="r-fit-text">Mission Profile</h1>
				<ul>
					<li>Surveilliance of Economic Zone</li>
					<li>Fisheries protection and law enforcement at sea</li>
					<li>Deterrence of smuggling and piracy</li>
					<li>Maritime search and rescue (SAR)</li>
					<li>Support for boarding parties and special operations</li>
					<li>Emergency Aviation Support</li>
					<li>Underwater surveillance utilizing hull-mounted sonar and future towed array capability</li>
				</ul>
			</section>
			<section>
				<h1 class="r-fit-text">Areas of Operation</h1>
				<img class="r-stretch" src="images/aoa.jpg"/>
				<a href="https://www.researchgate.net/publication/336233134_Initial_Measures_of_the_Bangladesh_Blue_Economy/citations">
				</a>
			</section>
            <section>
				<h1 class="r-fit-text">Staff Requirements</h1>
				<section>
					<h2 class="r-fit-text">Dimensional Requirements</h2>
					<p>The vessel‟s overall length is 75 m and the draft must not exceed 5 m. condition.</p>
				</section>
				<section>
					<h2 class="r-fit-text">Design Speed</h2>
					<p>The vessel‟s maximum speed must be 25 knots and the cruise speed must be 12 knots. </p>
				</section>
				<section>
					<h2 class="r-fit-text">Endurance</h2>
					<p>
						30 Days
					</p>
				</section>
				<section>
					<h2 class="r-fit-text">Range</h2>
					<p>
						6000 nautical miles @ 12 knots
					</p>
				</section>
				<section>
					<h2 class="r-fit-text">Aviation, and Underwater surveillance Facilities</h2>
					<ul>
						<li>Flight deck for AW109E. </li>
						<li>Underwater surveillance capability via hull-mounted sonar</li>
					</ul>
				</section>
				<section>
					<h2 class="r-fit-text">Weapons</h2>
					<section>
						<h3>Main Gun</h3>
					</section>
				</section>
				<section>
					<h2 class="r-fit-text">Sensors</h2>
				</section>
				<section>
					<h2 class="r-fit-text">Other Facilities</h2>
				</section>
			</section>
            <section>
                <h2>Parent form of Series-64</h2>
                <div class="model-container" id="modelContainer">
                    <div class="message-box" id="initialMessage">
                        <div class="spinner"></div>
                        <p>Initializing 3D viewer...</p>
                    </div>
                </div>
                <p id="statusText">Loading...</p>
            </section>
        </div>
    </div>

    <!-- Load Three.js with ALL required components -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Draco decoder must be loaded FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/draco/gltf/draco_decoder.js"></script>
    <!-- Then load DRACOLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
    <!-- Then GLTFLoader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <!-- Controls -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Reveal.js -->
    <script src="dist/reveal.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Starting 3D viewer with proper Draco setup...');
            
            // Initialize Reveal.js
            Reveal.initialize({ 
                hash: true,
                transition: 'slide'
            });
            
            let modelLoaded = false;
            let currentScene = null;
            let animationId = null;
            
            // Update status function
            function updateStatus(message, isError = false, isSuccess = false) {
                const statusEl = document.getElementById('statusText');
                if (statusEl) {
                    statusEl.innerHTML = `<span class="${isError ? 'error' : (isSuccess ? 'success' : '')}">${message}</span>`;
                }
                console.log('Status:', message);
            }
            
            // Main function to setup 3D scene
            function setup3DScene() {
                if (modelLoaded) return;
                
                const container = document.getElementById('modelContainer');
                const initialMessage = document.getElementById('initialMessage');
                
                if (initialMessage) {
                    initialMessage.innerHTML = '<div class="spinner"></div><p>Setting up 3D environment...</p>';
                }
                
                updateStatus('Initializing 3D scene...');
                
                // Clear previous animation if any
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                
                // Clear container
                container.innerHTML = '';
                
                // 1. Setup Three.js scene
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(
                    45,
                    container.clientWidth / container.clientHeight,
                    0.1,
                    1000
                );
                camera.position.set(5, 5, 5);
                
                const renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true
                });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setClearColor(0x006666, 1);
                container.appendChild(renderer.domElement);
                
                // 2. Add controls
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                
                // 3. Add lighting
                scene.add(new THREE.AmbientLight(0xffffff, 0.2));
                // Front light
                const frontLight = new THREE.DirectionalLight(0xffffff, 0.8);
                frontLight.position.set(0, 10, 20);
                scene.add(frontLight);

                // Back light
                const backLight = new THREE.DirectionalLight(0xffffff, 0.8);
                backLight.position.set(0, 10, -20);
                scene.add(backLight);

                // Right light
                const rightLight = new THREE.DirectionalLight(0xffffff, 1);
                rightLight.position.set(20, 10, 0);
                scene.add(rightLight);

                // Left light
                const leftLight = new THREE.DirectionalLight(0xffffff, 1);
                leftLight.position.set(-20, 10, 0);
                scene.add(leftLight);


                // 4. Add grid
                const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
                gridHelper.position.y = -1;
                scene.add(gridHelper);
                
                // 5. Add axis helper to the MAIN SCENE (not separate)
                // const axisHelper = new THREE.AxesHelper(5); // Size 5
                // axisHelper.position.set(0, 0, 0); // Center position
                // scene.add(axisHelper);
                
                // 5. Setup Draco loader - THIS IS THE FIX
                console.log('Setting up Draco loader...');
                console.log('THREE.DRACOLoader available:', typeof THREE.DRACOLoader !== 'undefined');
                console.log('DracoDecoderModule available:', typeof DracoDecoderModule !== 'undefined');
                
                const loader = new THREE.GLTFLoader();
                
                // Setup DRACOLoader if available
                if (typeof THREE.DRACOLoader !== 'undefined') {
                    try {
                        const dracoLoader = new THREE.DRACOLoader();
                        
                        // Use Google's stable Draco decoder - this is the key fix
                        dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.5/');
                        
                        loader.setDRACOLoader(dracoLoader);
                        console.log('✅ DRACOLoader configured successfully with Google decoder');
                        updateStatus('Draco decoder ready, loading model...');
                    } catch (dracoError) {
                        console.error('Failed to setup DRACOLoader:', dracoError);
                        updateStatus('Warning: Draco decoder failed, trying without...', true);
                    }
                } else {
                    console.warn('DRACOLoader not available in THREE namespace');
                    updateStatus('Warning: No Draco support, model may fail to load', true);
                }
                
                // 6. Create status display
                const statusBox = document.createElement('div');
                statusBox.className = 'message-box';
                statusBox.style.cssText = 'top: 10px; left: 10px; transform: none; background: rgba(0,0,0,0.8); padding: 10px;';
                statusBox.textContent = 'Loading hu.glb...';
                container.appendChild(statusBox);
                
                // 7. Load the model
                console.log('Loading model: hu.glb');
                
                loader.load(
                    'hu.glb',
                    
                    // Success callback
                    function(gltf) {
                        console.log('✅ Model loaded successfully!', gltf);
                        statusBox.textContent = '✅ Model loaded!';
                        statusBox.style.color = '#4CAF50';
                        statusBox.style.backgroundColor = 'rgba(0,100,0,0.8)';
                        
                        const model = gltf.scene;
                        
                        // ⭐⭐⭐ DOUBLE-SIDE FIX ⭐⭐⭐
                        model.traverse(function(child) {
                            if (child.isMesh) {
                                // This makes both front and back faces visible
                                child.material.side = THREE.DoubleSide;
                                child.material.map = null; // Remove texture
                                child.material.color = new THREE.Color(0xffff00);
                            }
                        });
                        
                        // Center and scale the model
                        const box = new THREE.Box3().setFromObject(model);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());
                        
                        const maxDim = Math.max(size.x, size.y, size.z);
                        const scale = maxDim > 0 ? 5 / maxDim : 1;
                        
                        model.position.x = -center.x * scale;
                        model.position.y = -center.y * scale;
                        model.position.z = -center.z * scale;
                        model.scale.set(scale, scale, scale);
                        
                        scene.add(model);
                        controls.target.copy(model.position);
                        
                        updateStatus('✓ 3D model loaded and displayed', false, true);
                        
                        // Remove status box after 3 seconds
                        setTimeout(() => {
                            if (statusBox.parentNode === container) {
                                container.removeChild(statusBox);
                            }
                        }, 3000);
                        
                        modelLoaded = true;
                    },
                    
                    // Progress callback
                    function(xhr) {
                        if (xhr.lengthComputable) {
                            const percent = Math.round((xhr.loaded / xhr.total) * 100);
                            statusBox.textContent = `Loading: ${percent}%`;
                            updateStatus(`Loading model: ${percent}%`);
                        }
                    },
                    
                    // Error callback
                    function(error) {
                        console.error('❌ Error loading model:', error);
                        
                        let errorMessage = 'Unknown error occurred';
                        
                        if (error.message && error.message.includes('DRACOLoader')) {
                            errorMessage = 'Draco decompression failed. Your model needs conversion.';
                            statusBox.innerHTML = `
                                <h3 class="warning">⚠️ Draco Compression Error</h3>
                                <p>Your hu.glb file uses Draco compression that can't be decoded.</p>
                                <p><strong>Solution:</strong> Convert to non-Draco format</p>
                                <p>
                                    <a href="https://gltf-transform.donmccurdy.com/" 
                                       target="_blank" 
                                       class="button">
                                        Convert Online Now
                                    </a>
                                </p>
                                <p style="margin-top: 10px; font-size: 12px;">
                                    Upload → Select "None" for Compression → Convert → Download → Replace hu.glb
                                </p>
                            `;
                        } else if (error.message && error.message.includes('404')) {
                            errorMessage = 'File hu.glb not found in project folder.';
                            statusBox.innerHTML = `
                                <h3 class="error">❌ File Not Found</h3>
                                <p>Place hu.glb in the same folder as index.html</p>
                            `;
                        } else {
                            errorMessage = error.message || 'Check browser console';
                            statusBox.innerHTML = `
                                <h3 class="error">❌ Load Error</h3>
                                <p>${errorMessage}</p>
                            `;
                        }
                        
                        statusBox.style.color = '#ff4444';
                        statusBox.style.backgroundColor = 'rgba(100,0,0,0.8)';
                        updateStatus(errorMessage, true);
                        
                        // Add fallback cube with double-side fix
                        addFallbackCube(scene, statusBox);
                    }
                );
                
                // 8. Animation loop
                function animate() {
                    animationId = requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                
                animate();
                
                // 9. Handle window resize
                function handleResize() {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                }
                
                window.addEventListener('resize', handleResize);
                
                currentScene = { scene, camera, renderer, controls, animate };
                modelLoaded = true;
            }
            
            // Add fallback cube with double-side fix
            function addFallbackCube(scene, statusBox) {
                const geometry = new THREE.BoxGeometry(2, 2, 2);
                const materials = [
                    new THREE.MeshBasicMaterial({ color: 0xff0000, side: THREE.DoubleSide }),
                    new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide }),
                    new THREE.MeshBasicMaterial({ color: 0x0000ff, side: THREE.DoubleSide }),
                    new THREE.MeshBasicMaterial({ color: 0xffff00, side: THREE.DoubleSide }),
                    new THREE.MeshBasicMaterial({ color: 0xff00ff, side: THREE.DoubleSide }),
                    new THREE.MeshBasicMaterial({ color: 0x00ffff, side: THREE.DoubleSide })
                ];
                const cube = new THREE.Mesh(geometry, materials);
                scene.add(cube);
                
                // Add rotation to cube
                function rotateCube() {
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;
                    requestAnimationFrame(rotateCube);
                }
                rotateCube();
                
                if (statusBox) {
                    const originalContent = statusBox.innerHTML;
                    statusBox.innerHTML = originalContent + 
                        '<p style="margin-top: 15px; border-top: 1px solid #666; padding-top: 10px;">' +
                        '<small>Showing fallback cube (both faces visible)</small></p>';
                }
            }
            
            // ====== TRIGGER LOADING ======
            
            // Load when on model slide
            function checkSlideAndLoad() {
                const currentSlide = Reveal.getCurrentSlide();
                const container = document.getElementById('modelContainer');
                
                if (currentSlide && container && currentSlide.contains(container)) {
                    console.log('On model slide, setting up scene...');
                    setup3DScene();
                    return true;
                }
                return false;
            }
            
            // Set up event listeners
            Reveal.on('slidechanged', checkSlideAndLoad);
            Reveal.on('ready', function() {
                console.log('Reveal.js ready, checking initial slide...');
                if (!checkSlideAndLoad()) {
                    updateStatus('Navigate to slide 2 to view 3D model');
                }
            });
            
            // Initial check after a short delay
            setTimeout(() => {
                if (!modelLoaded) {
                    console.log('Initial timeout check...');
                    checkSlideAndLoad();
                }
            }, 500);
            
            // Force load after 3 seconds if needed (for debugging)
            setTimeout(() => {
                if (!modelLoaded) {
                    console.log('Force loading model for debugging...');
                    setup3DScene();
                }
            }, 3000);
            
            // Expose for debugging
            window.debugLoadModel = setup3DScene;
            window.forceModelLoad = function() {
                modelLoaded = false;
                setup3DScene();
            };
        });
    </script>
</body>
</html>